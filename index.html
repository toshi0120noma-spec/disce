<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dice Fortune | げーまー哲</title>
<style>
  :root{
    --accent:#24AAED; --ink:#0a0a0a; --bg:#ffffff; --soft:#f3f6f9;
    --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08);
    --btn-bg:#222; --btn-ink:#EADCC2;
    --avatar:120px;          /* アイコン一辺 */
    --gutter:16px;           /* テキスト↔アイコン間 */
    --overlap:8px;           /* ボタンの“食い込み”量 */
  }
  html,body{height:100%;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;}
  .wrap{max-width:880px;margin:0 auto;padding:24px}
  .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}

  .stage{
    margin:4px 0;border-radius:var(--radius);background:var(--soft);padding:22px;
    display:grid;grid-template-columns:1fr;gap:18px;align-items:stretch;
  }
  @media (min-width:760px){ .stage{grid-template-columns:1.1fr 1fr} }

  /* ===== 左：ダイス（既存のまま） ===== */
  .dice-area{
    display:grid;place-items:center;position:relative;border-radius:14px;
    background:radial-gradient(1200px 400px at 50% 0%, rgba(36,170,237,.12), transparent);
    padding:18px; min-height:340px; overflow:hidden;
  }
  .dice-grid{
    width:100%; display:grid; grid-template-columns:1fr 1fr;
    gap:min(5vw,20px); align-items:center; justify-items:center;
  }
  .die-wrap{position:relative; display:grid; place-items:center;}
  .die{
    width:min(32vw,180px); height:min(32vw,180px);
    background-size:contain; background-repeat:no-repeat; background-position:center;
    will-change:transform,filter; transform-style:preserve-3d;
    filter:drop-shadow(0 14px 28px rgba(0,0,0,.18));
  }
  .die.spin{animation:spinY 2.2s cubic-bezier(.05,.65,.25,1) forwards;}
  @keyframes spinY{
    0%  {transform:rotateX(10deg) rotateY(0deg); filter:drop-shadow(0 8px 18px rgba(0,0,0,.14));}
    100%{transform:rotateX(10deg) rotateY(1440deg); filter:drop-shadow(0 14px 28px rgba(0,0,0,.18));}
  }
  .die.tilt-a{transition:transform .18s ease;transform:rotateX(14deg) rotateZ(-6deg)}
  .die.tilt-b{transition:transform .18s ease;transform:rotateX(12deg) rotateZ(5deg)}
  @media (prefers-reduced-motion:reduce){
    .die.spin{animation-duration:.4s}
    .die.tilt-a,.die.tilt-b{transition-duration:.08s}
  }
  .die-num{
    position:absolute; inset:0; display:grid; place-items:center;
    font-weight:900; letter-spacing:.02em; font-size:clamp(38px,8.5vw,68px);
    color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.35),0 0 1px rgba(0,0,0,.3);
    opacity:0; transform:scale(.9); transition:opacity .25s ease,transform .25s ease;
    pointer-events:none;
  }
  .die-num.show{opacity:1;transform:scale(1)}

  /* ===== 右：結果（等高＋下固定。アイコン右下、ボタン重ね） ===== */
  .result{
    position:relative; border-radius:16px; overflow:hidden;
    background:
      linear-gradient(#fff,#fff) padding-box,
      linear-gradient(135deg, rgba(36,170,237,.28), rgba(36,170,237,0)) border-box;
    border:1px solid transparent;

    /* 右下のアイコンとボタンを想定した余白計算
       - 右は “アイコン幅 + gutter” を常時確保
       - 下は ボタン高 + 余白 で切れないよう確保 */
    --btn-h: 40px; --pad: 18px;
    padding:
      18px
      calc(var(--pad) + var(--avatar) + var(--gutter))
      calc(var(--pad) + var(--btn-h) + 12px)
      18px;

    display:flex; flex-direction:column; height:100%;
    box-sizing:border-box;
  }
  .result::before{
    content:""; position:absolute; left:14px; right:14px; top:10px; height:3px;
    border-radius:999px; background:linear-gradient(90deg, var(--accent), rgba(36,170,237,.15));
    opacity:.85; pointer-events:none;
  }

  .crit{
    margin:6px 0 4px; font-weight:900; letter-spacing:.06em;
    font-size:clamp(16px,3.2vw,20px);
    background:linear-gradient(90deg, #111, #3a3a3a);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow:0 1px 0 rgba(0,0,0,.06);
  }
  .sum{margin:0;opacity:.9;font-size:clamp(16px,3vw,18px);font-weight:800}
  .big{margin:2px 0 0;font-weight:900;font-size:clamp(20px,3.6vw,26px)}
  .comment{margin:8px 0 0;opacity:.95;font-size:clamp(13px,2.4vw,15px);line-height:1.8}

  .spacer{flex:1}

  .actions{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    position:relative; z-index:2;   /* ← アイコンより前面に */
  }
  .btn{border:none;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;gap:12px}
  /* ボタン：固定サイズ＆“アイコン側へ8px食い込み” */
  .btn.primary{
    background:var(--btn-bg); color:var(--btn-ink);
    padding:10px 44px; border-radius:999px;
    font-size:clamp(14px,2.8vw,18px); letter-spacing:.02em;
    line-height:1; min-height:var(--btn-h); white-space:nowrap; min-width:220px;
    position:relative; transform:translateX(var(--overlap));
  }
  .btn.primary::before{content:"";width:10px;height:10px;border-radius:50%;background:var(--btn-ink);display:inline-block}

  /* アイコン：右下固定。ボタンと“軽く重ねる” */
  .avatar{
    position:absolute; right:18px; bottom:calc(18px + var(--btn-h) - var(--overlap));
    width:var(--avatar); height:var(--avatar);
    border-radius:14px; background:linear-gradient(180deg, #f7fafc, #eef4f9);
    border:1px solid #e7edf4; box-shadow:var(--shadow);
    overflow:hidden; display:grid; place-items:center; z-index:1;  /* ボタンの後ろ */
  }
  .avatar img{width:100%; height:100%; object-fit:cover; display:block;}

  /* 狭い画面では重なりとアイコンサイズを少し弱める */
  @media (max-width:759px){
    :root{ --avatar:96px; --overlap:4px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="stage">
        <!-- 左：ダイス -->
        <div class="dice-area">
          <div class="dice-grid">
            <div class="die-wrap">
              <div class="die" id="dieA" aria-hidden="true"></div>
              <div class="die-num" id="numA" aria-live="polite"></div>
            </div>
            <div class="die-wrap">
              <div class="die" id="dieB" aria-hidden="true"></div>
              <div class="die-num" id="numB" aria-live="polite"></div>
            </div>
          </div>
        </div>

        <!-- 右：結果 -->
        <div class="result">
          <!-- 右下固定のアイコン（振る前後で位置は1mmも動かない） -->
          <div class="avatar"><img id="moodIcon" src="icons/mood_calm.png" alt="mood icon" decoding="async" /></div>

          <p class="crit" id="critBanner" style="display:none;"></p>
          <p class="sum" id="sumLabel">合計：—</p>
          <p class="big" id="fortuneLabel">今日の運勢：—</p>
          <p class="comment" id="fortuneComment"></p>

          <div class="spacer"></div>

          <div class="actions">
            <button class="btn primary" id="rollBtn">ダイスを振る</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="sfx" src="sound/dice.mp3" preload="auto"></audio>

<script>
  /* 画像パス */
  const diceImages = { A:'img/d20_a.png', B:'img/d20_b.png' };
  const moodByTier = {
    super:    'icons/mood_super.png',
    critical: 'icons/mood_crit.png',
    '超大吉': 'icons/mood_super.png',
    '大吉':   'icons/mood_crit.png',
    '吉':     'icons/mood_good.png',
    '中吉':   'icons/mood_mid.png',
    '小吉':   'icons/mood_calm.png',
    '末吉':   'icons/mood_warn.png',
    '凶':     'icons/mood_bad.png',
    '大凶':   'icons/mood_bad.png'
  };

  /* 要素 */
  const dieA = document.getElementById('dieA');
  const dieB = document.getElementById('dieB');
  const numA = document.getElementById('numA');
  const numB = document.getElementById('numB');
  const fortuneLabel = document.getElementById('fortuneLabel');
  const fortuneComment = document.getElementById('fortuneComment');
  const sumLabel = document.getElementById('sumLabel');
  const critBanner = document.getElementById('critBanner');
  const moodIcon = document.getElementById('moodIcon');
  const rollBtn = document.getElementById('rollBtn');
  const sfx = document.getElementById('sfx');

  /* プリロード */
  [diceImages.A, diceImages.B, ...new Set(Object.values(moodByTier))].forEach(src=>{ const i=new Image(); i.src=src; });
  dieA.style.backgroundImage = `url(${diceImages.A})`;
  dieB.style.backgroundImage = `url(${diceImages.B})`;

  let endTimer = null;

  const fortunes = {
    "超大吉": ["今日はすべてが味方です。肩の力を抜いて、そのまま進みましょう。", "がんばってきたことが、静かに花ひらく日。自分を信じて大丈夫。", "小さな喜びが重なって、心がふわっと軽くなりそう。"],
    "大吉":   ["いい風が吹いています。素直な一歩が、思わぬ実りに。", "あなたの魅力が伝わる日。やさしい言葉から始めてみて。", "気持ちの余裕が、素敵なご縁を呼び込みます。"],
    "吉":     ["無理をしなくても、ちゃんと前に進めていますよ。", "丁寧に選んだ行動が、やがて確かな実感に。", "ほどよいペースで、心地よさを大切に。"],
    "中吉":   ["静かな追い風。焦らず、できることから積み重ねましょう。", "あなたらしいやり方で大丈夫。落ち着いて、ゆっくりと。", "小さな調整で、ぐっと過ごしやすくなります。"],
    "小吉":   ["今日は“整える”が吉。休むことも立派な前進です。", "やさしい気配りが、思いのほか伝わっていきますよ。", "ほどよく手放して、身軽に過ごしましょう。"],
    "末吉":   ["慎重さが味方。今日は深呼吸を多めに。", "準備を整えれば、安心して次に進めます。", "無理に広げず、今あるものを丁寧に。"],
    "凶":     ["うまくいかない時は、少しだけ歩みをゆるめましょう。", "あたたかい飲み物で一息。明日に期待で大丈夫。", "今日は守りの日。自分を責めないで。"],
    "大凶":   ["立ち止まる勇気が、あなたを守ってくれます。", "いまは温めるとき。整えてからで間に合います。", "大切なものほど、ゆっくりと育ちます。"]
  };

  function fortuneFromPair(a,b){
    if (a===20 && b===20) return ['スーパークリティカル・超大吉','超大吉','super'];
    if (a===b)            return ['クリティカル・大吉','大吉','critical'];
    const sum=a+b;
    if (sum>=34) return ['吉','吉',null];
    if (sum>=28) return ['中吉','中吉',null];
    if (sum>=22) return ['小吉','小吉',null];
    if (sum>=16) return ['末吉','末吉',null];
    if (sum>=10) return ['凶','凶',null];
    return ['大凶','大凶',null];
  }

  function clearNumbers(){
    numA.classList.remove('show'); numA.textContent='';
    numB.classList.remove('show'); numB.textContent='';
  }

  function showCriticalBanner(kind){
    if (!kind){ critBanner.style.display='none'; critBanner.textContent=''; return; }
    critBanner.innerHTML = (kind==='super')
      ? `✦<span style="opacity:.7">✧</span> <strong>スーパークリティカル！！</strong> <span style="opacity:.7">✧</span>✦`
      : `✦ <strong>クリティカル！</strong> ✦`;
    critBanner.style.display='block';
  }

  function setMoodIcon(tier, kind){
    const key = kind ? kind : tier;
    const src = moodByTier[key] || 'icons/mood_calm.png';
    moodIcon.src = src; /* 位置・サイズ不変、srcのみ差し替え */
  }

  function roll(){
    try{ sfx.currentTime=0; sfx.play(); }catch(e){}
    if (endTimer){ clearTimeout(endTimer); endTimer=null; }

    [dieA,dieB].forEach(d=>{ d.classList.remove('tilt-a','tilt-b','spin'); void d.offsetWidth; d.classList.add('spin'); });
    clearNumbers();
    showCriticalBanner(null);
    fortuneLabel.textContent='今日の運勢：—';
    fortuneComment.textContent='';
    sumLabel.textContent='合計：—';

    const ROLL_MS=2200;
    endTimer=setTimeout(()=>{
      [dieA,dieB].forEach(d=>d.classList.remove('spin'));
      setTimeout(()=>{ dieA.classList.add('tilt-a'); dieB.classList.add('tilt-b'); },40);

      const a=1+Math.floor(Math.random()*20);
      const b=1+Math.floor(Math.random()*20);
      const sum=a+b;
      const [display,tier,critKind]=fortuneFromPair(a,b);

      sumLabel.textContent = (a===b) ? `合計：${sum}（${a}のゾロ目）` : `合計：${sum}`;
      showCriticalBanner(critKind);
      fortuneLabel.textContent=`今日の運勢：${display}`;
      const pool = fortunes[tier] || [];
      fortuneComment.textContent = pool.length ? pool[Math.floor(Math.random()*pool.length)] : '';

      setMoodIcon(tier, critKind);

      setTimeout(()=>{
        numA.textContent=a; numA.classList.add('show');
        numB.textContent=b; numB.classList.add('show');
      },140);

      const url=new URL(location.href);
      url.searchParams.set('r1',a); url.searchParams.set('r2',b);
      history.replaceState({},'',url);

      endTimer=null;
    },ROLL_MS);
  }

  (function initFromURL(){
    const p=new URLSearchParams(location.search);
    const r1=Number(p.get('r1')), r2=Number(p.get('r2'));
    if (r1>=1&&r1<=20&&r2>=1&&r2<=20){
      const [display,tier,critKind]=fortuneFromPair(r1,r2);
      const sum=r1+r2;
      sumLabel.textContent = (r1===r2) ? `合計：${sum}（${r1}のゾロ目）` : `合計：${sum}`;
      showCriticalBanner(critKind);
      fortuneLabel.textContent=`今日の運勢：${display}`;
      const pool = fortunes[tier] || [];
      fortuneComment.textContent = pool.length ? pool[Math.floor(Math.random()*pool.length)] : '';
      setMoodIcon(tier, critKind);

      numA.textContent=r1; numB.textContent=r2; numA.classList.add('show'); numB.classList.add('show');
      dieA.classList.add('tilt-a'); dieB.classList.add('tilt-b');
    } else {
      setMoodIcon('小吉', null);
    }
  })();

  document.getElementById('rollBtn').addEventListener('click', roll);
</script>
</body>
</html>




